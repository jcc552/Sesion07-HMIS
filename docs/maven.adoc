////
Codificación, idioma, tabla de contenidos, tipo de documento
////
:encoding: utf-8
:lang: es
:toc: right
:toc-title: Tabla de contenidos
:keywords: Maven HMIS
:doctype: book
:icons: font

////
/// activar btn:
////
:experimental:

:source-highlighter: rouge
:rouge-linenums-mode: inline

// :highlightjsdir: ./highlight

:figure-caption: Figure
:example-caption!: 

// Eliminar el bloque final "last updated"
:reproducible:      

// PDF
:pdf-style: themes/my-theme.yml
:title_page: false
// Bloque de codigo en pdf: no incluir la sección "Tabla de contenidos"
ifdef::backend-pdf[]
:toc!:
endif::[]


////
///  Copy button on code blocks
////
[.doc]

:docinfo: shared-footer

////
Nombre y título del trabajo
////
= Maven
Herramientas y Métodos de Ingeniería del Software
Version 2.0, Marzo-2023
Joaquín Cañadas <jjcanada@ual.es>


// Entrar en modo no numerado de apartados
:numbered!: 

[abstract]
////
COLOCA A CONTINUACIÓN EL RESUMEN
////

https://maven.apache.org/what-is-maven.html[Maven] es una herramienta de construcción y gestión de dependencias para proyectos Java. Maven se encarga de la gestión del ciclo de vida del proyecto, incluyendo la compilación, la ejecución de los test, la generación de documentación, el empaquetado y la distribución del software. Además, proporciona un sistema de construcción estandarizado y una estructura de proyecto coherente, lo que hace que sea más fácil para los desarrolladores trabajar en proyectos grandes y complejos. Además, proporciona gestión de dependencias, es decir, permite que un proyecto pueda utilizar librerías de terceros sin tener que preocuparse de cómo se instalan, cómo se actualizan, etc. Pero Maven es mucho más que eso: el objetivo principal de es permitir que un desarrollador comprenda el estado completo de un esfuerzo de desarrollo en el menor tiempo posible. Para lograr este objetivo, Maven se ocupa de varias áreas:

- _Facilitar el proceso de construcción_

- _Proporcionar un sistema de construcción uniforme_

- _Proporcionar información de proyectos de calidad_

- _Fomentar mejores prácticas de desarrollo_


////
COLOCA A CONTINUACIÓN LOS OBJETIVOS
////
.Objetivos
* 
* 


# Prerrequisitos

El guion de esta actividad está actualizado para JUnit5. Para cada proyecto de la actividad 05 - Pruebas Unitarias en JUnit.

## Configuración del UTF-8 en el IDE

### Eclipse
====
image:images/eclipse_2.png[Eclipse] Si estás usando Eclipse, no olvides configurar Eclipse para que utilice UTF-8 como codificación predeterminada: _Window > Preferencies > General > Workspace > Text file encoding > Other > UTF-8_

image::images/eclipse-utf8.png[Eclipse utf8]
====

### Visual Studio Code
====
image:images/Visual_Studio_Code_icon.png[VSCode] Si usas VS Code para desarrollar en Java: 

. Instala las extensiones Java, Maven, Java Debugger

. Si no configuras el UTF-8 en el IDE, los tests de caracteres con acentos o con eñes fallarán. Configurar UTF-8 en la compilación y depuración con Java: Extensions / Java Debugger

image::images/vscode-java-utf8.png[vscode-java-utf8]

Esto se traduce en el archivo de `settings.json` del usuario en:

[source,json]
----
   "java.debug.settings.vmArgs": "-Dfile.encoding=UTF-8"
----
====


# Pasos a seguir

// Entrar en modo numerado de apartados
:numbered:

## Convertir a proyecto Maven

====
image:images/eclipse_2.png[Eclipse] Si en la actividad 5 habías partido del proyecto en GitHub, como ualhmis/junitEjercicios o ualhmis/hmis-coches, este paso y los dos siguientes ya están hechos. Simplemente debes comprobar que ya lo habíamos hecho en la actividad 5. Si, por el contrario, tu(s) proyecto(s) de la actividad 5 no están mavenizados, hazlo ahora:

Sobre el proyecto, botón derecho, _Configure_, _Convert to maven project_

image::images/convert-to-maven-project.png[convert-to-maven-project]

Verás que se ha creado un nuevo archivo llamado `pom.xml` que es el que contiene la configuración de Maven para el proyecto.
====

====
image:images/Visual_Studio_Code_icon.png[VSCode] Si usas VS Code para desarrollar en Java, haz lo siguiente:

. Crea un archivo `pom.xml` en la raíz del proyecto, con el siguiente contenido básico:

[source,xml]
----
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<groupId>hmis-coches</groupId>
	<artifactId>hmis-coches</artifactId>
	<version>0.0.1-SNAPSHOT</version>
    <build>
    	<plugins>
			<plugin>
				<artifactId>maven-compiler-plugin</artifactId>
				<version>3.11.0</version>
				<configuration>
					<release>11</release>
				</configuration>
			</plugin>
        </plugins>
    </build>
</project>
----
====

El contenido mínimo del `pom.xml` es:

* `project` root
* `modelVersion` - debe ser `4.0.0`
* `groupId` - identificador del grupo del proyecto.
* `artifactId` - identificador de artefacto (proyecto)
* `version` - version del artefacto bajo el grupo especificado

Los parámetros `groupId`, `artifactId`, y `version` forma el nombre completo de artefacto del proyecto (project's fully qualified artifact name). Este nombre tiene la forma `<groupId>:<artifactId>:<version>`. En el ejemplo anterior, sería `hmis-coches.hmis-coches:0.0.1-SNAPSHOT`.

* `build` - contiene la configuración de construcción del proyecto, y los plugins que se ejecutan durante la misma. En el ejemplo anterior, se configura el plugin `maven-compiler-plugin` para que compile con *Java 11*.


## Configurar el archivo `pom.xml`

La estructura predeterminada de un proyecto Maven sigue una convención denominada "Standard Directory Layout" (Estructura de Directorios Estándar), que proporciona una forma coherente de organizar los archivos de un proyecto. Esta estructura se compone de los siguientes directorios y subdirectorios:

====
- El directorio `src/main/java` contiene el código fuente principal del proyecto.
- El directorio `src/main/resources` contiene los recursos (archivos de configuración, archivos de propiedades, etc.) necesarios para que el proyecto se ejecute.
- El directorio `src/test/java` contiene los archivos de prueba del proyecto.
- El directorio `src/test/resources` contiene los recursos necesarios para las pruebas.
- El archivo `pom.xml` es el archivo de configuración de Maven que describe cómo se debe construir el proyecto, incluyendo las dependencias, plugins y otros detalles.
- El directorio `target` es donde Maven coloca los resultados de la construcción y el empaquetado del proyecto.
====

Si tu proyecto Java tiene otra estructura distinta a esta estructura de carpetas predeterminada, puedes modificarla en el archivo `pom.xml`. Por ejemplo, partiendo de la estructura de proyecto habitual en Eclipse, los fuentes están en la carpeta `src` y las clases con tests en la carpeta `test`. 

Para empezar, debes configurar el proyecto con *codificación `UTF-8`*, y las carpetas donde están los fuentes y los tests:

[source,xml]
----
<properties>
  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
</properties>

<build>
  <sourceDirectory>src</sourceDirectory>
  <testSourceDirectory>test</testSourceDirectory>
   ...
</build>
----


## Añadir las dependencias a JUnit5

Maven proporciona gestión de dependencias, es decir, permite que un proyecto pueda utilizar librerías de terceros sin tener que preocuparse de cómo se instalan, cómo se actualizan, etc.  A partir de ahora, deberás configurar el archivo `pom.xml` para que incluya las dependencias necesarias para el proyecto.

Añade las dependencias a JUnit 5 (simplemente comprobar, ya lo habíamos hecho en la actividad 5):

[source,xml]
----
	<dependency>
		<groupId>org.junit.jupiter</groupId>
		<artifactId>junit-jupiter-engine</artifactId>
		<version>5.9.2</version> <1>
		<scope>test</scope>
	</dependency>
	<dependency>
		<groupId>org.junit.jupiter</groupId>
		<artifactId>junit-jupiter-api</artifactId>
		<version>5.9.2</version>
		<scope>test</scope>
	</dependency>
   	<dependency>
		<groupId>org.junit.jupiter</groupId>
		<artifactId>junit-jupiter-params</artifactId>
		<version>5.9.2</version>
		<scope>test</scope>
	</dependency>
----
<1> La versión de JUnit5 que usamos en el momento de escribir este documento es la `5.9.2`, pero debes comprobar la última versión en https://mvnrepository.com/artifact/org.junit.jupiter/junit-jupiter-api y usarla en tu `pom.xml`, en las tres dependencias de JUnit5.

[WARNING]
====
image:images/eclipse_2.png[Eclipse] En Eclipse, hay que eliminar JUnit del ClassPath del proyecto 

Si en el proyecto aparecen errores de compilación tras añadir las dependencias a Junit en Maven, se debe *actualizar el proyecto*: sobre el proyecto, botón derecho, _Maven, Update Project_.

image::images/maven-update-project.png[maven-update-project]
====


## Lanzar los test desde Maven

Maven define un ciclo de vida (https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html[Maven lifecycle]) para compilar/test/empaquetar el proyecto. El ciclo de vida de Maven es un conjunto predefinido de fases que describen el proceso de construcción y distribución de un proyecto. Cada fase representa una etapa específica en el ciclo de vida de construcción de un proyecto, y se ejecutan en un orden predefinido.

Los *goals* de Maven son tareas específicas que se pueden ejecutar en un proyecto durante el proceso de construcción. Cada fase del ciclo de vida de Maven está compuesta por uno o más goals, y los goals se utilizan para realizar acciones específicas, como compilar el código fuente, ejecutar pruebas, empaquetar el proyecto, instalar el proyecto en el repositorio local de Maven, y desplegar el proyecto en un servidor remoto.

Por ejemplo, en la fase *compile* del ciclo de vida de Maven, el goal principal es `compile`, que se utiliza para compilar el código fuente del proyecto y generar archivos `.class`. En la fase *test*, el goal principal es `test`, que se utiliza para ejecutar las pruebas unitarias del proyecto. En la fase *package*, el goal principal es `package`, que se utiliza para empaquetar el proyecto en un archivo `.jar` o `.war`. El goal `clean` se utiliza para limpiar el resultado de la construcción anterior, borrando en la carpeta `target`.

En cada _goal_ se ejecutan otros _goals_ previos necesarios para que el actual se ejecute correctamente. Por ejemplo, al ejecutar `test`, Maven ejecuta previamente `compile` y `testCompile`. Del mismo modo, `package` ejecuta previamente los goals `compile`, `testCompile` y `test`.

.https://www.codetab.org/tutorial/apache-maven/maven-lifecycle-goals/[Maven lifecycle goals]
image::images/mvn-plugins-package-goals.png[maven-package-goal]

====
image:images/eclipse_2.png[Eclipse] Normalmente hasta ahora siempre hemos ejecutado los tests de JUnit desde *Eclipse*, con la opción _Run As… JUnit test_. Ahora vamos a lanzar los test desde *Maven*: _Sobre el proyecto, Botón derecho, Run as… , Maven build_. En el campo Goals: `clean package`

image::images/maven-build-clean-package.png[maven-build-clean-package]
====

====
image:images/Visual_Studio_Code_icon.png[VSCode] En VS Code, para lanzar los test desde Maven, desde el terminal ejecuta: 

[source,bash]
----
mvn clean package
----
====

WARNING: Recuerda que para ejecutar los test con Maven desde el terminal, debes tener instalado Maven en tu sistema operativo. Comprueba que lo tienes instalado con el comando `mvn -v`. Si no lo tienes instalado, puedes descargarlo desde https://maven.apache.org/download.cgi, aunque la instalación recomendada en Windows es con Chocolatey: https://chocolatey.org/packages/maven


[WARNING]
====
Si maven no compila, da error: del tipo `--release` en maven (el `pom.xml` tiene release 11):

- check your JAVA_HOME environment variable.
- I was setting the value of release to 11 as I am using JAVA 11.
- My System JAVA_HOME was set for java 8.
- After changing the JAVA_HOME user environment variable to the java 11 path, this got resolved.
====

Una vez ejecutada correctamente la construcción con Maven, comprueba en la *salida por consola* que se hayan ejecutando los tests correctamente: número de tests, Passed, Failed, ...

image::images/maven-test-results.png[maven-test-results]

En caso de que no se estén ejecutando los tests *(Tests run: 0)* el problema es que Maven no está encontrando los tests. Para solucionarlo es necesario configurar el plugin *Surefire*, encargado de los tests unitarios, tal y como se explica en la siguiente sección.  


Puedes comprobar el resultado de la ejecución de los test de JUnit abriendo el archivo xml generado en la carpeta `target/surefire-reports/TEST-….xml`

image::images/open-xml-test-junit.png[open-xml-test-junit]


[WARNING]
====
Si en la consola aparece el siguiente error: 

 No compiler is provided in this environment. Perhaps you are running on a JRE rather than a JDK?

En Eclipse:_Window -> Preferences -> Java -> Installed JREs_ Comprueba que está marcada una instalación de JDK en lugar de un JRE. 
 
Si no tuvieses instalado un JDK, debes instalarlo. Recomendable *JDK 11*. Tras instalarlo, debes reiniciar Eclipse y añadirlo a la lista de Installed JREs.
====

## Añadir el plugin de Surefire

Surefire es el plugin de Maven que se encarga de ejecutar los tests unitarios. Por defecto, Surefire busca los tests en el directorio `src/test/java` y los ejecuta. Si no se encuentra ningún test, no se ejecuta ninguno. Por eso, si no se ejecutan los tests, es porque Maven no los encuentra.

Añade esta configuración del plugin al `pom.xml`

[source,xml]
----
<build>
   <plugins>
	...
	<plugin>
		<groupId>org.apache.maven.plugins</groupId>
		<artifactId>maven-surefire-plugin</artifactId>
		<version>3.0.0</version>
	</plugin>
	...
   </plugins>
</build>
----

https://maven.apache.org/surefire/maven-surefire-plugin/examples/junit-platform.html

De forma predeterminada, Surefire Plugin automáticamente incluye todos los archivos de pruebas que cumplen las siguientes reglas de nomenclatura:
•	"**/Test*.java" – incluye todos los archivos .java que empiezan por "Test".
•	"**/*Test.java" - incluye todos los archivos .java que finalizan en "Test".    
•	 "**/*Tests.java" – incluye todos archivos .java que finalizan en "Tests".
•	"**/*TestCase.java" - incluye todos archivos .java que finalizan en "TestCase".
Si tus clases de test no siguen esta nomenclatura, configura el plugin para especificar que incluir: 


##

##

##
## Referencias


